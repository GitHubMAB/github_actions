name: Terraform Azure Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:

  # ------------------------------
  # JOB 1 : Checkout & Terraform Setup
  # ------------------------------
  terraform-setup:
    name: Checkout & Setup Terraform
    runs-on: ubuntu-latest
    outputs:
      terraform-workspace: ${{ steps.set-env.outputs.workspace }}
    steps:
      # Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Installer Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.4.5'

      # Installer Python pour Checkov
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

  # ------------------------------
  # JOB 2 : Checkov Scan & SARIF Upload
  # ------------------------------
  checkov-scan:
    name: Terraform Security Scan with Checkov
    runs-on: ubuntu-latest
    needs: terraform-setup
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Exécuter Checkov
      - name: Run Checkov
        continue-on-error: true
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          framework: terraform
          output_file_path: results.sarif
          output_format: sarif
          quiet: false

      # Upload SARIF pour GitHub Advanced Security
      - name: Upload SARIF File
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: checkov

      # Commit & push les résultats Checkov
      - name: Commit & Push Checkov Results
        if: always()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
      
          # Ajouter le fichier SARIF
          git add results.sarif
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Add Checkov scan results"
            git push origin ${{ github.ref }}
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  # ------------------------------
  # JOB 3 : Terraform Apply
  # ------------------------------
  terraform-apply:
    name: Terraform Init & Apply
    runs-on: ubuntu-latest
    needs: [terraform-setup, checkov-scan]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Export ARM variables
      - name: Export ARM Variables
        run: |
          echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_SKIP_CLI_AUTH=true" >> $GITHUB_ENV

      # Terraform init
      - name: Terraform Init
        run: |
          yes yes | terraform init -reconfigure \
            -backend-config="resource_group_name=${{ secrets.TF_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_SA }}" \
            -backend-config="container_name=${{ secrets.TF_CONTAINER }}" \
            -backend-config="key=${{ secrets.TF_KEY }}"

      # Terraform validate
      - name: Terraform Validate
        run: terraform validate

      # Terraform plan
      - name: Terraform Plan
        run: terraform plan

      # Terraform apply (push seulement)
      - name: Terraform Apply
        if: github.event_name == 'push'
        run: terraform apply -auto-approve

      # Sauvegarder kubeconfig
      - name: Save kubeconfig
        run: terraform output -raw kubeconfig > kubeconfig
        shell: bash

      # Upload kubeconfig pour les jobs suivants
      - name: Upload kubeconfig
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: kubeconfig

  # ------------------------------
  # JOB 4 : Get AKS Credentials
  # ------------------------------
  aks-credentials:
    name: Get AKS Credentials
    runs-on: ubuntu-latest
    needs: terraform-apply
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Télécharger kubeconfig généré par Terraform
      - name: Download kubeconfig
        uses: actions/download-artifact@v4
        with:
          name: kubeconfig
          path: ./kubeconfig

      # Azure login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Copier kubeconfig dans le dossier standard
      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          cp ./kubeconfig ~/.kube/config

      # Installer kubectl
      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      # Vérifier la connexion
      - name: Verify Cluster Connection
        run: kubectl get nodes

  # ------------------------------
  # JOB 5 : Install Helm
  # ------------------------------
  helm-setup:
    name: Install Helm CLI
    runs-on: ubuntu-latest
    needs: aks-credentials
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Installer Helm
      - name: Setup Helm
        uses: azure/setup-helm@v3

  # ------------------------------
  # JOB 6 : Deploy Helm Chart
  # ------------------------------
  helm-deploy:
    name: Deploy Helm Chart to AKS
    runs-on: ubuntu-latest
    needs: [aks-credentials, helm-setup]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Déployer l’application Helm
      - name: Deploy Helm Chart
        run: |
          helm upgrade --install myapp ./myapp \
            --namespace default \
            --create-namespace
